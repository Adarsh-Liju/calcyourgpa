<head>
  <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/realm-web@1.2.0/dist/bundle.iife.js"></script>
</head>

<body>
  <div class="p-12">
    Input your previous sem gpa:
    <input type="text" id="prev-gpa" class="rounded p-2 border-2" placeholder="6.9" />
    <br />
    Input the previous sem grade deduction:
    <input type="text" class="rounded p-2 border-2" id="grade-deduction" value="0.75" placeholder="0.75" />
    <br />
    Input the class interval (Marks range for each grade):
    <input type="number" class="rounded p-2 border-2" id="class-interval" value="10" placeholder="10"
      onchange="updateGradeDivs(this)" />
    <div id="grade-divs"></div>
    <br />
    Include Lab and Project?<br />
    <label class="switch">
      <input type="checkbox" id="labs" onchange="displayLabOutput(this)" />
      <span class="slider round"></span>
    </label>
    <br />
    <br />
    <hr />
    <br />
    <div id="main-marks"></div>

    <div id="lab-marks"></div>
    <br />
    <hr />
    <br />
    <button onclick="computeGPA()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">GET MY
      GPA BICH</button>
    <h1 id="output"></h1>
  </div>
  <script>
    const app = new Realm.App({ id: "application-0-dopcr" });
    (async () => {
      async function mongo_auth() {
        // Create an anonymous credential
        const credentials = Realm.Credentials.anonymous();
        try {
          // Authenticate the user
          const user = await app.logIn(credentials);
          // `App.currentUser` updates to match the logged in user
          if (user.id === app.currentUser.id) {
            return user;
          }

        } catch (err) {
          console.error("Failed to log in", err);
        }

      }

      const user = await mongo_auth();
      async function logUser(user) {
        const res = await user.functions.logUser({ "Test": "Test data" });
        console.log(res);

      }
      logUser(user);

    })().catch(err => {
      console.error(err);
    });

    updateGradeDivs();
    var labcap = 0;

    let subjects = ["ELECTIVE_1", "ELECTIVE_2", "CC", "OOAD", "CD"];
    let labs = ["Lab 1 (CC)", "Lab 2 (OOAD)", "Capstone Phase 1"];

    let toggle = document.getElementById("lab-marks");
    window.addEventListener("load", displayOutput);

    function computeGPA() {
      var prevgpa = parseFloat(document.getElementById("prev-gpa").value) - parseFloat(document.getElementById("grade-deduction").value),
        assmark_elem = document.querySelectorAll(".ass-mark"),
        isamark_elem = document.querySelectorAll(".isa-mark"),
        assoutof_elem = document.querySelectorAll(".ass-outof"),
        isaoutof_elem = document.querySelectorAll(".isa-outof"),
        credits = document.querySelectorAll(".credits"),
        nonsubjects = document.querySelectorAll(".lab-mark"),
        laboutof = document.querySelectorAll(".lab-outof"),
        subjectnames = document.querySelectorAll(".subjectname"),
        n = subjects.length,
        m = nonsubjects.length;
      subjectnames = Object.keys(subjectnames).map((x) => (subjectnames[x].innerHTML).trim());
      assmark = Object.keys(assmark_elem).map((x) => parseFloat(assmark_elem[x].value));
      isamark = Object.keys(isamark_elem).map((x) => parseFloat(isamark_elem[x].value));
      assoutof = Object.keys(assoutof_elem).map((x) => parseFloat(assoutof_elem[x].value));
      isaoutof = Object.keys(isaoutof_elem).map((x) => parseFloat(isaoutof_elem[x].value));
      credits = Object.keys(credits).map((outo) =>
        parseFloat(credits[outo].value)
      );
      nonsubjects = Object.keys(nonsubjects).map((outo) =>
        parseFloat(nonsubjects[outo].value)
      );
      laboutof = Object.keys(laboutof).map((outo) =>
        parseFloat(laboutof[outo].value)
      );
      let marks = [];
      for (var i = 0; i < n; i++) {
        let x = (assmark[i] / assoutof[i]) * 0.15 + (isamark[i] / isaoutof[i]) * 0.35;
        marks.push(x);
      }
      for (var i = 0; i < m; i++) {
        let x = (nonsubjects[i] / laboutof[i]) * 0.5;
        marks.push(x);
      }

      marks = marks.map(mark => mark * 100);

      var finalmarks = []
      var prevgpascore = (prevgpa * 10) * 0.5;
      for (var i = 0; i < n; i++) {
        finalmarks.push(marks[i] + prevgpascore);
      }
      var finalgrade = [];
      let top_ci = 100
      var ci = parseInt(document.getElementById("class-interval").value);
      let grades = [];
      for (var i = 0; i < credits.length; i++) {
        let grade = "F";
        if (finalmarks[i] > top_ci - ci) {
          grade = "S";
          finalgrade[i] = 10;
        } else if (finalmarks[i] > top_ci - (2 * ci)) {
          grade = "A";
          finalgrade[i] = 9;
        } else if (finalmarks[i] > top_ci - (3 * ci)) {
          grade = "B";
          finalgrade[i] = 8;
        } else if (finalmarks[i] > top_ci - (4 * ci)) {
          grade = "C";
          finalgrade[i] = 7;
        } else if (finalmarks[i] > top_ci - (5 * ci)) {
          grade = "D";
          finalgrade[i] = 5;
        } else if (finalmarks[i] > top_ci - (6 * ci)) {
          grade = "E";
          finalgrade[i] = 4;
        } else {
          finalgrade[i] = 0;
        }
        grades.push({
          grade,
          name: subjectnames[i]
        });
      }
      let markSum = 0;
      let creditsSum = 0;
      let gradesOutput = "";
      for (var i = 0; i < credits.length; i++) {
        markSum += finalgrade[i] * credits[i];
        creditsSum += credits[i];
        gradesOutput += `<tr>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div class="ml-4">
                    <div class="text-sm font-medium text-gray-900">
                      ${grades[i].name}
                    </div>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${credits[i]}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${["S", "A"].includes(grades[i].grade) ? "bg-green-100 text-green-800" : ["B", "C", "D", "E"].includes(grades[i].grade) ? "bg-yellow-100 text-yellow-800" : "bg-red-100 text-red-800"} ">
                  ${grades[i].grade}
                </span>
              </td>
            </tr>`
      }

      if (labcap === 1) {
        var labs_grad_elem = document.querySelectorAll(".lab-grade");
        var lab_grade = Object.keys(labs_grad_elem).map((x) => labs_grad_elem[x].value);
        var labs_credits = document.querySelectorAll(".lab-credits");
        var lab_credits = Object.keys(labs_credits).map((x) => parseFloat(labs_credits[x].value));
        for (var i = 0; i < 3; i++) {
          grade = lab_grade[i];
          grades.push({
            grade,
            name: labs[i],
          });
        }
        for (var i = 0; i < 3; i++) {
          switch (lab_grade[i]) {
            case "S":
              markSum += 10 * lab_credits[i];
              break;
            case "A":
              markSum += 10 * lab_credits[i];
              break;
            case "B":
              markSum += 10 * lab_credits[i];
              break;
            case "C":
              markSum += 10 * lab_credits[i];
              break;
            case "D":
              markSum += 10 * lab_credits[i];
              break;
            case "E":
              markSum += 10 * lab_credits[i];
              break;
            case "F":
              markSum += 10 * lab_credits[i];
              break;
          }
          creditsSum += lab_credits[i];
          gradesOutput += `<tr>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div class="ml-4">
                    <div class="text-sm font-medium text-gray-900">
                      ${grades[i + 5].name}
                    </div>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${lab_credits[i]}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${["S", "A"].includes(grades[i + 5].grade) ? "bg-green-100 text-green-800" : ["B", "C", "D", "E"].includes(grades[i + 5].grade) ? "bg-yellow-100 text-yellow-800" : "bg-red-100 text-red-800"} ">
                  ${grades[i + 5].grade}
                </span>
              </td>
            </tr>`

        }
      }

      var finalMarks = markSum / creditsSum;
      console.log(marks, finalgrade, finalMarks, creditsSum)
      let outputd = document.getElementById("output");
      outputd.innerHTML = `<p class='2xl-text'>✨ ${finalMarks} ✨</p><br/><hr/><br/>
      <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Course
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Credits
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Grade
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            ${gradesOutput}
          </tbody>
        </table>
      `;
    }

    function updateGradeDivs() {
      var ci = parseInt(document.getElementById("class-interval").value);
      let outputdiv = document.getElementById("grade-divs");

      var max_ci = 100;
      var output = "<table><tr><th>Grade</th><th>Marks Interval</th></tr>"
      var grades = ["S", "A", "B", "C", "D", "E", "F"]
      var cis = []
      for (var i = 0; i < 7; i++) {
        var ci2 = max_ci - ci;
        cis.push(`${max_ci} to ${ci2 + 1}`);
        max_ci = ci2;
      }
      for (var i = 0; i < 7; i++) {
        output += `<tr><td>${grades[i]}</td><td>${cis[i]}</td></tr>`
      }
      output += "</table>"
      outputdiv.innerHTML = output;

    }
    function displayOutput() {
      outputdiv = document.getElementById("main-marks");
      output = "";
      subjects.forEach(
        (subjectname) =>
        (output += `

          <div class="p-8 border-4">
          <h2 class="text-2xl bold subjectname">
              ${subjectname}
          </h2>
          assignment: <input type="number" class="ass-mark rounded p-2 border-2" placeholder="6.9"/> out of <input type="number" class="ass-outof rounded p-2 border-2" placeholder="15" value="15" /><br/>
          <br/>isa: <input type="number" class="isa-mark rounded p-2 border-2" placeholder="6.9"/> out of <input type="number" class="isa-outof rounded p-2 border-2" placeholder="60" value="60" /><br/>
          <br/>credits: <input type="number" class="credits rounded p-2 border-2" placeholder="4" value="4" /><br/>
          </div>
      `)
      );
      outputdiv.innerHTML = output;
    }

    function displayLabOutput(e) {
      outputdiv = document.getElementById("lab-marks");
      var credlab = [1, 1, 2];
      var labclasses = ["lab", "cap"]
      if (e.checked) {
        labcap = 1;
        output = "";
        for (var i = 0; i < 3; i++) {
          output += `
            <div class="p-8 border-4">
                <h2 class="text-2xl">
                    ${labs[i]}
                </h2>
                Expected Grade: <select class="lab-grade" name="${labclasses}-grade">
                                  <option value="S">S</option>
                                  <option value="A">A</option>
                                  <option value="B">B</option>
                                  <option value="C">C</option>
                                  <option value="D">D</option>
                                  <option value="E">E</option>
                                  <option value="F">F</option>
                                </select><br/>
                <br/>credits: <input type="number" class="lab-credits rounded p-2 border-2" placeholder="${credlab[i]}" value="${credlab[i]}" /><br/>      
            </div>`
        }
        outputdiv.innerHTML = output;
      } else {
        outputdiv.innerHTML = "";
        labcap = 0;
      }
    }
  </script>
  <style>
    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 20px;
    }

    /* Hide default HTML checkbox */
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    /* The slider */
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      -webkit-transition: .4s;
      transition: .4s;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 2px;
      background-color: white;
      -webkit-transition: .4s;
      transition: .4s;
    }

    input:checked+.slider {
      background: linear-gradient(to right, red, orange, yellow, rgb(43, 231, 43), blue, rgb(114, 54, 114));
    }

    input:focus+.slider {
      box-shadow: 0 0 1px #000000;
    }

    input:checked+.slider:before {
      -webkit-transform: translateX(38px);
      -ms-transform: translateX(38px);
      transform: translateX(38px);
    }

    /* Rounded sliders */
    .slider.round {
      border-radius: 34px;
    }

    .slider.round:before {
      border-radius: 50%;
    }
  </style>

</body>
